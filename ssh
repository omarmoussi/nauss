Mysql server preparation:
Installation mysql-server:
apt update
apt install mysql-server
Allow remote access to MySQL:
nano /etc/mysql/mysql.conf.d/mysqld.cnf
     Change line
      bind-address = 127.0.0.1  to #bind-address = 127.0.0.1 
Restart MySQL service:
service mysql restart
Create remote mysql user:
CREATE USER 'sabaya'@'10.164.0.3' IDENTIFIED BY 'password';
GRANT ALL ON *.* TO 'sabaya'@'10.164.0.3';
FLUSH PRIVILEGES;
Laravel server preparation:
Install php:
apt-get install software-properties-common -y
add-apt-repository ppa:ondrej/php
apt-get install -y php8.3-common php8.3-gmp php8.3-curl php8.3-soap php8.3-bcmath php8.3-intl php8.3-mbstring php8.3-xmlrpc php8.3-mysql php8.3-gd php8.3-xml php8.3-cli php8.3-zip php8.3-fpm
Install redis:
apt-get install -y redis
Install Composer
curl -sS https://getcomposer.org/installer -o composer-setup.php
sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer


Project deployment:
code source path: /var/www/html/sabayabackend
 update env file and runcommande;

composer update
php artisan clear-compiled
php artisan migrate --force
sudo php artisan cache:clear
php artisan route:clear
php artisan view:clear
php artisan config:clear
php artisan config:cache
update permission




######
rm -f /etc/apt/sources.list.d/ondrej-php.list
rm -f /usr/share/keyrings/ondrej-php.gpg

curl -fsSL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x4F4EA0AAE5267A6C" \
| gpg --dearmor \
| sudo tee /usr/share/keyrings/ondrej-php.gpg > /dev/null

ls -l /usr/share/keyrings/ondrej-php.gpg


CODENAME=$(lsb_release -sc)

echo "deb [signed-by=/usr/share/keyrings/ondrej-php.gpg] \
https://ppa.launchpadcontent.net/ondrej/php/ubuntu \
$CODENAME main" \
| sudo tee /etc/apt/sources.list.d/ondrej-php.list


sudo apt update


sudo chown -R www-data:www-data /var/www/html/sabayabackend
sudo find  /var/www/html/sabayabackend -type f -exec chmod 664 {} \;   
sudo find  /var/www/html/sabayabackend -type d -exec chmod 775 {} \;
sudo chmod -R ug+rwx storage bootstrap/cache



curl -fsSL https://nginx.org/keys/nginx_signing.key | sudo gpg --dearmor -o /usr/share/keyrings/nginx-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] http://nginx.org/packages/ubuntu $(lsb_release -cs) nginx" | sudo tee /etc/apt/sources.list.d/nginx.list
sudo apt update
sudo apt install -y nginx



sudo apt-get install lsb-release curl gpg
curl -fsSL https://packages.redis.io/gpg | sudo gpg --dearmor -o /usr/share/keyrings/redis-archive-keyring.gpg
sudo chmod 644 /usr/share/keyrings/redis-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/redis.list
sudo apt-get update
sudo apt-get install redis




# Exemple pour Ubuntu/Debian
wget https://repo.percona.com/apt/percona-release_latest.generic_all.deb
sudo dpkg -i percona-release_latest.generic_all.deb
sudo percona-release setup pxc80
sudo apt update
sudo apt install percona-xtradb-cluster



matser 
[mysqld]
server-id=2   
datadir=/var/lib/mysql
socket=/var/run/mysqld/mysqld.sock
log-error=/var/log/mysql/error.log
bind-address = 0.0.0.0
######## wsrep ###############
wsrep_provider=/usr/lib/libgalera_smm.so
pxc-encrypt-cluster-traffic=OFF
# Liste identique au Nœud 1
wsrep_cluster_address=gcomm://192.168.1.10,192.168.1.11,192.168.1.12

binlog_format=ROW
default_storage_engine=InnoDB
wsrep_slave_threads=8
innodb_autoinc_lock_mode=2

# IP locale de ce nœud
wsrep_node_address=192.168.1.11
wsrep_cluster_name=mon_cluster_percona
wsrep_node_name=node-2

pxc_strict_mode=ENFORCING
wsrep_sst_method=xtrabackup-v2



slave 
[mysqld]
server-id=1
datadir=/var/lib/mysql
socket=/var/run/mysqld/mysqld.sock
log-error=/var/log/mysql/error.log
pid-file=/var/run/mysqld/mysqld.pid
bind-address = 0.0.0.0

######## wsrep (Galera) ###############
wsrep_provider=/usr/lib/libgalera_smm.so
wsrep_cluster_name=mon_cluster_percona
wsrep_cluster_address=gcomm://192.168.1.10,192.168.1.11,192.168.1.12
wsrep_node_address=192.168.1.10
wsrep_node_name=node-1

binlog_format=ROW
default_storage_engine=InnoDB
innodb_autoinc_lock_mode=2

# Désactivation SSL pour résoudre l'erreur de certificat
pxc-encrypt-cluster-traffic=OFF
pxc_strict_mode=ENFORCING
wsrep_sst_method=xtrabackup-v2
https://eu.onetimesecret.com/secret/63hsxrrap968wcph6zl8jidj0zx6xu4
sudo update-alternatives --remove-all mysql
sudo update-alternatives --remove-all my.cnf
sudo apt-get update
sudo apt-get install percona-xtradb-cluster
global
    log /dev/log local0
    log /dev/log local1 notice
    daemon
    maxconn 4096
    user haproxy
    group haproxy

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 10s
    timeout client  1m
    timeout server  1m

# =========================
# FRONTEND MYSQL
# =========================
frontend mysql_front
    bind *:3306
    mode tcp
    default_backend mysql_cluster

# =========================
# BACKEND MYSQL GALERA
# =========================
backend mysql_cluster
    mode tcp
    balance leastconn
    option mysql-check user haproxy

    server db1 10.0.1.6:3306 check inter 2s rise 2 fall 3
    server db2 10.0.1.7:3306 check inter 2s rise 2 fall 3
    server db3 10.0.1.8:3306 check inter 2s rise 2 fall 3



global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

# --- Page de statistiques (Optionnel mais très utile) ---
listen stats
    bind *:8080
    mode http
    stats enable
    stats uri /
    stats refresh 10s
    stats auth admin:votre_mot_de_passe

# --- Configuration du Cluster MySQL ---
listen mysql_cluster
    bind *:3306
    mode tcp
    option mysql-check user haproxy_check
    balance roundrobin
    server node1 192.168.1.10:3306 check
    server node2 192.168.1.11:3306 check
    server node3 192.168.1.12:3306 check
-- Création de l'utilisateur 'haproxy_user' capable de se connecter de n'importe où
CREATE USER 'haproxy_user'@'%' IDENTIFIED BY 'votre_mot_de_passe_fort';

-- Accorder les privilèges nécessaires (ajustez selon vos besoins, ici accès total)
GRANT ALL PRIVILEGES ON *.* TO 'haproxy_user'@'%' WITH GRANT OPTION;

-- Appliquer les changements
FLUSH PRIVILEGES;
